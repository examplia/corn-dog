<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Corn Dog Clicker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="icon" href="üå≠">
  <meta property="og:title" content="Today I Will Eat Five Corn Dogs">
  <meta property="og:description" content="Join the corn dog reaper on his noble mission.">
  <meta property="og:image" content="https://iwilleatcorndogs.today/corn-dog-reaper.gif">
  <meta property="og:url" content="https://iwilleatcorndogs.today/">
  <meta name="twitter:card" content="summary_large_image">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyChqD_9j3np8jnrM4BXDnhrRl4r52TamZk",
      authDomain: "corn-dog-clicker.firebaseapp.com",
      projectId: "corn-dog-clicker",
      storageBucket: "corn-dog-clicker.firebasestorage.app",
      messagingSenderId: "824338629929",
      appId: "1:824338629929:web:8d49dd2b7923bf41976338"
    };
    
    // Add authorized domains
    const authorizedDomains = [
      'iwilleatcorndogs.today',
      'www.iwilleatcorndogs.today',
      'localhost',
      'corn-dog-clicker.firebaseapp.com'
    ];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Enable debug logging
    auth.useDeviceLanguage();
    
    // Set auth persistence to local
    setPersistence(auth, browserLocalPersistence)
      .catch((error) => {
        console.error("Auth persistence error:", error);
        alert("Failed to enable login persistence. You may need to log in again after refreshing.");
      });

    let userId = null;
    let username = null;
    let gameStarted = false;
    let chatListener = null;

    // Login system
    function showLoginUI() {
      const gameContent = document.getElementById('gameContent');
      const loginUI = document.getElementById('loginUI');
      if (gameContent) gameContent.style.display = 'none';
      if (loginUI) loginUI.style.display = 'block';
    }

    function showGameUI() {
      const gameContent = document.getElementById('gameContent');
      const loginUI = document.getElementById('loginUI');
      if (gameContent) gameContent.style.display = 'block';
      if (loginUI) loginUI.style.display = 'none';
    }

    // Chat functions
    async function sendChatMessage(message) {
      if (!userId || !username || !message.trim()) return;
      
      try {
        await addDoc(collection(db, "chat"), {
          userId: userId,
          username: username,
          message: message.trim().substring(0, 200), // Limit message length
          timestamp: serverTimestamp(),
          cornDogs: count // Show user's corn dog count
        });
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }

    function startChatListener() {
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;
      
      // Clean up existing listener
      if (chatListener) {
        chatListener();
      }
      
      // Start new listener
      const q = query(
        collection(db, "chat"),
        orderBy("timestamp", "desc"),
        limit(50)
      );
      
      chatListener = onSnapshot(q, (snapshot) => {
        const messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        
        // Reverse to show newest at bottom
        messages.reverse();
        
        messagesContainer.innerHTML = messages.map(msg => `
          <div class="chat-message ${msg.userId === userId ? 'own-message' : ''}">
            <span class="chat-username">${msg.username || 'Anonymous'}</span>
            <span class="chat-count">${numberFormat(msg.cornDogs || 0)} üå≠</span>
            <div class="chat-text">${msg.message}</div>
          </div>
        `).join('');
        
        // Auto-scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Game functions
    function updateUI() {
      if (!counterElem) {
        counterElem = document.getElementById("counter");
        moneyElem = document.getElementById("money");
        dpsElem = document.getElementById("dps");
        prestigeInfoElem = document.getElementById("prestige-info");
        comboCounterElem = document.getElementById("combo-counter");
        critChanceElem = document.getElementById("crit-chance");
        goldenFoundElem = document.getElementById("golden-found");
        bossKillsElem = document.getElementById("boss-kills");
      }
      
      if (counterElem) counterElem.textContent = numberFormat(count);
      if (moneyElem) moneyElem.textContent = `$${numberFormat(money)}`;
      if (dpsElem) dpsElem.textContent = `${numberFormat(autoClickers + passiveIncome)}/s`;
      if (prestigeInfoElem) prestigeInfoElem.textContent = `Prestige Lv.${prestigeLevel} (x${prestigeMultiplier.toFixed(1)} bonus)`;
      if (comboCounterElem) comboCounterElem.textContent = `x${comboCount}`;
      if (critChanceElem) critChanceElem.textContent = `${(critChance * 100).toFixed(1)}%`;
      if (goldenFoundElem) goldenFoundElem.textContent = goldenCornDogsFound;
      if (bossKillsElem) bossKillsElem.textContent = bossKills;
      
      // Update shop buttons
      const shop = document.getElementById("upgrades");
      if (shop) {
        shop.innerHTML = `
          <div class="upgrade">
            <button id="buy-mult" ${money >= Math.floor(UPGRADES.multiplier.base * Math.pow(UPGRADES.multiplier.scale, multiplier - 1)) ? '' : 'disabled'}>
              <div class="upgrade-header">
                <span class="upgrade-icon">üí™</span>
                <span class="upgrade-name">${UPGRADES.multiplier.name}</span>
              </div>
              <div class="upgrade-details">
                <span class="upgrade-desc">Level ${multiplier} ‚Üí ${multiplier + 1}</span>
                <span class="upgrade-cost">$${numberFormat(Math.floor(UPGRADES.multiplier.base * Math.pow(UPGRADES.multiplier.scale, multiplier - 1)))}</span>
              </div>
            </button>
          </div>
          <div class="upgrade">
            <button id="buy-auto" ${money >= Math.floor(UPGRADES.autoClicker.base * Math.pow(UPGRADES.autoClicker.scale, autoClickers)) ? '' : 'disabled'}>
              <div class="upgrade-header">
                <span class="upgrade-icon">ü§ñ</span>
                <span class="upgrade-name">${UPGRADES.autoClicker.name}</span>
              </div>
              <div class="upgrade-details">
                <span class="upgrade-desc">+${autoClickers}/s ‚Üí +${autoClickers + 1}/s</span>
                <span class="upgrade-cost">$${numberFormat(Math.floor(UPGRADES.autoClicker.base * Math.pow(UPGRADES.autoClicker.scale, autoClickers)))}</span>
              </div>
            </button>
          </div>
          <div class="upgrade">
            <button id="buy-passive" ${money >= Math.floor(UPGRADES.passive.base * Math.pow(UPGRADES.passive.scale, passiveIncome)) ? '' : 'disabled'}>
              <div class="upgrade-header">
                <span class="upgrade-icon">üí∞</span>
                <span class="upgrade-name">${UPGRADES.passive.name}</span>
              </div>
              <div class="upgrade-details">
                <span class="upgrade-desc">+${passiveIncome}/s ‚Üí +${passiveIncome + 1}/s</span>
                <span class="upgrade-cost">$${numberFormat(Math.floor(UPGRADES.passive.base * Math.pow(UPGRADES.passive.scale, passiveIncome)))}</span>
              </div>
            </button>
          </div>
        `;
        
        // Reattach event listeners
        const buyMultBtn = document.getElementById("buy-mult");
        const buyAutoBtn = document.getElementById("buy-auto");
        const buyPassiveBtn = document.getElementById("buy-passive");
        
        if (buyMultBtn) buyMultBtn.addEventListener("click", handleUpgrade("multiplier"));
        if (buyAutoBtn) buyAutoBtn.addEventListener("click", handleUpgrade("autoClicker"));
        if (buyPassiveBtn) buyPassiveBtn.addEventListener("click", handleUpgrade("passive"));
      }

      // Update prestige button
      const prestigeBtn = document.getElementById('prestige-btn');
      if (prestigeBtn) {
        prestigeBtn.disabled = count < PRESTIGE_COST;
        prestigeBtn.innerHTML = `
          <div class="prestige-content">
            <span class="prestige-icon">‚≠ê</span>
            <span class="prestige-text">PRESTIGE</span>
            <span class="prestige-req">${count >= PRESTIGE_COST ? 'READY!' : `Need ${numberFormat(PRESTIGE_COST - count)} more`}</span>
          </div>
        `;
      }
    }

    async function loadData() {
      console.log('Loading data...');
      const docRef = doc(db, "users", userId);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        count = data.count || 0;
        money = data.money || 0;
        multiplier = data.multiplier || 1;
        autoClickers = data.autoClickers || 0;
        upgradeLevel = data.upgradeLevel || 1;
        passiveIncome = data.passiveIncome || 0;
        prestigeLevel = data.prestigeLevel || 0;
        prestigeMultiplier = 1 + (prestigeLevel * 0.5);
        goldenCornDogsFound = data.goldenCornDogsFound || 0;
        bossKills = data.bossKills || 0;
        totalClicks = data.totalClicks || 0;
        maxCombo = data.maxCombo || 0;
        username = data.username || auth.currentUser?.email?.split('@')[0] || 'Unknown';
      }
      updateUI();
    }

    function spawnCornDog() {
      console.log('Spawning corn dog...');
      if (Math.random() < 0.05 && count >= 1000) { // 5% chance to spawn boss after 1000 corn dogs
        spawnBoss();
        return;
      }

      const isGolden = Math.random() < goldenCornDogChance;
      const corndog = document.createElement("div");
      corndog.className = `corndog ${isGolden ? 'golden-corndog' : ''}`;
      corndog.textContent = "üå≠";
      
      // Better positioning - avoid UI elements
      const margin = 100;
      const gameArea = document.getElementById('game-area');
      const bounds = gameArea ? gameArea.getBoundingClientRect() : { 
        left: 0, 
        top: 100, 
        width: window.innerWidth, 
        height: window.innerHeight - 200 
      };
      
      corndog.style.top = (bounds.top + Math.random() * (bounds.height - 100)) + "px";
      corndog.style.left = (bounds.left + Math.random() * (bounds.width - 100)) + "px";
      document.body.appendChild(corndog);

      const spawnSound = document.getElementById("spawnSound");
      if (spawnSound) {
        spawnSound.currentTime = 0;
        try {
          spawnSound.play().catch(() => {}); // Ignore autoplay blocking
        } catch (e) {}
      }

      corndog.addEventListener("click", handleCornDogClick);
      corndog.addEventListener("touchstart", handleCornDogClick);

      async function handleCornDogClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const baseValue = isGolden ? GOLDEN_CORNDOG_VALUE : multiplier;
        const isCrit = Math.random() < critChance;
        const clickValue = baseValue * (isCrit ? critMultiplier : 1);
        
        count += clickValue;
        money += clickValue;
        totalClicks++;
        
        if (isGolden) {
          goldenCornDogsFound++;
        }
        
        updateCombo(e.pageX || e.touches?.[0]?.pageX, e.pageY || e.touches?.[0]?.pageY);
        updateUI();
        
        try {
          document.getElementById("eatSound")?.play().catch(() => {});
        } catch (e) {}
        
        let displayText = `+${numberFormat(clickValue)}`;
        if (isCrit) displayText = `CRIT! ${displayText}`;
        if (isGolden) displayText = `‚ú®GOLDEN! ${displayText}`;
        
        spawnFloatingText(
          e.pageX || e.touches?.[0]?.pageX, 
          e.pageY || e.touches?.[0]?.pageY, 
          displayText, 
          isGolden ? 'golden' : isCrit ? 'crit' : 'normal'
        );
        corndog.remove();
        await saveData();
        checkAchievements();
      }

      setTimeout(() => {
        if (document.body.contains(corndog)) corndog.remove();
      }, 8000);
    }

    function spawnBoss() {
      if (currentBoss) return; // Don't spawn if boss already exists
      
      const boss = BOSSES[Math.floor(Math.random() * Math.min(BOSSES.length, Math.floor(count / 10000) + 1))];
      const bossElem = document.createElement("div");
      bossElem.className = "boss";
      bossElem.innerHTML = `
        <div class="boss-name">${boss.name}</div>
        <div class="boss-health">
          <div class="health-bar" style="width: 100%"></div>
        </div>
        <div class="boss-image" style="font-size: ${boss.scale}rem;">${boss.image}</div>
        <div class="boss-hp">${boss.health}/${boss.health} HP</div>
      `;
      
      bossElem.style.left = "50%";
      bossElem.style.top = "50%";
      bossElem.style.transform = "translate(-50%, -50%)";
      document.body.appendChild(bossElem);
      
      currentBoss = { ...boss, currentHealth: boss.health, element: bossElem };
      
      bossElem.addEventListener("click", handleBossClick);
      bossElem.addEventListener("touchstart", handleBossClick);

      async function handleBossClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const damage = multiplier * (Math.random() < critChance ? critMultiplier : 1);
        currentBoss.currentHealth -= damage;
        
        const healthPercent = (currentBoss.currentHealth / currentBoss.health) * 100;
        const healthBar = bossElem.querySelector(".health-bar");
        const hpDisplay = bossElem.querySelector(".boss-hp");
        
        healthBar.style.width = Math.max(0, healthPercent) + "%";
        hpDisplay.textContent = `${Math.max(0, currentBoss.currentHealth)}/${currentBoss.health} HP`;
        
        spawnFloatingText(
          e.pageX || e.touches?.[0]?.pageX, 
          e.pageY || e.touches?.[0]?.pageY, 
          `-${numberFormat(damage)}`, 
          'damage'
        );
        
        if (currentBoss.currentHealth <= 0) {
          money += currentBoss.reward;
          bossKills++;
          spawnFloatingText(
            window.innerWidth/2,
            window.innerHeight/2,
            `Boss Defeated! +$${numberFormat(currentBoss.reward)}!`,
            'boss-reward'
          );
          bossElem.remove();
          currentBoss = null;
          await saveData();
          checkAchievements();
        }
      }
    }

    function startGame() {
      console.log('Starting game...');
      loadData().then(() => {
        console.log('Data loaded, starting spawn interval...');
        if (spawnInterval) {
          clearInterval(spawnInterval);
        }
        spawnInterval = setInterval(spawnCornDog, 1200);
        console.log('Spawn interval started');
        setInterval(startRandomEvent, 60000); // Check for random events every minute
        setInterval(() => { 
          timePlayedSeconds++; 
          checkDailyChallenges();
        }, 1000);
        
        // Start chat listener
        startChatListener();
      }).catch(error => {
        console.error('Error starting game:', error);
      });
    }

    function handleAuth(user) {
      if (user) {
        console.log('User authenticated:', user.uid);
        userId = user.uid;
        showGameUI();
        if (!gameStarted) {
          console.log('Starting new game...');
          startGame();
          gameStarted = true;
        }
      } else {
        console.log('No user authenticated, showing login UI');
        showLoginUI();
      }
    }

    onAuthStateChanged(auth, handleAuth);

    // Game state variables
    let count = 0;
    let money = 0;
    let multiplier = 1;
    let autoClickers = 0;
    let bossHealth = 0;
    let currentBoss = null;
    let upgradeLevel = 1;
    let passiveIncome = 0;
    let prestigeLevel = 0;
    let prestigeMultiplier = 1;
    let critChance = 0.1;
    let critMultiplier = 2;
    let comboCount = 0;
    let maxCombo = 0;
    let achievements = {};
    let goldenCornDogChance = 0.01;
    let lastClickTime = 0;
    let clicksPerSecond = 0;
    let totalClicks = 0;
    let bossKills = 0;
    let goldenCornDogsFound = 0;
    let timePlayedSeconds = 0;
    let spawnInterval;
    let dailyProgress = {};
    let lastDailyReset = 0;

    async function handleLogin(e) {
      e.preventDefault();
      const usernameInput = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (usernameInput.length < 3) {
        alert('Username must be at least 3 characters long');
        return;
      }

      if (password.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
      }

      // Show loading state
      const submitBtn = document.querySelector('#loginForm button');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Loading...';
      submitBtn.disabled = true;

      try {
        const email = `${usernameInput.trim()}@corndogs.game`;
        username = usernameInput; // Store username
        console.log('Attempting to sign in with:', email);
        // First try to sign in
        await signInWithEmailAndPassword(auth, email, password);
        console.log('Login successful!');
      } catch (error) {
        console.log('Login attempt error:', error.code, error.message);
        
        // If user doesn't exist or credentials invalid, try to register
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
          try {
            console.log('Attempting to create new account');
            await createUserWithEmailAndPassword(auth, email, password);
            console.log('Account created successfully');
          } catch (createError) {
            console.log('Registration error:', createError.code);
            let errorMessage = '';
            switch(createError.code) {
              case 'auth/email-already-in-use':
                errorMessage = 'This username is already taken. Try a different one or check your password if this is your account.';
                break;
              case 'auth/invalid-email':
                errorMessage = 'Invalid username. Use only letters, numbers, and common symbols.';
                break;
              case 'auth/operation-not-allowed':
                errorMessage = 'Registration is currently disabled. Please try again later.';
                break;
              case 'auth/weak-password':
                errorMessage = 'Password must be at least 6 characters long';
                break;
              default:
                errorMessage = 'Error creating account. Please try again.';
            }
            alert(errorMessage);
          }
        } else {
          let errorMessage = '';
          switch(error.code) {
            case 'auth/wrong-password':
              errorMessage = 'Incorrect password';
              break;
            case 'auth/invalid-credential':
              errorMessage = 'Invalid username or password';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'Too many attempts. Please try again later.';
              break;
            default:
              errorMessage = 'Error logging in. Please try again.';
          }
          alert(errorMessage);
        }
      } finally {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

      // Initialize DOM elements
      let counterElem, moneyElem, dpsElem, prestigeInfoElem, comboCounterElem, critChanceElem, goldenFoundElem, bossKillsElem;

      // Constants - Moved outside DOMContentLoaded for global access
      const PRESTIGE_COST = 1000000;
      const GOLDEN_CORNDOG_VALUE = 1000;
      const MAX_COMBO_TIME = 2000; // 2 seconds to maintain combo
      
      const ACHIEVEMENTS = {
        clicks: [
          { id: 'click1', name: 'Getting Started', req: 10, reward: 25 },
          { id: 'click2', name: 'Click Enthusiast', req: 100, reward: 100 },
          { id: 'click3', name: 'Click Master', req: 1000, reward: 1000 },
          { id: 'click4', name: 'Click Legend', req: 10000, reward: 10000 },
          { id: 'click5', name: 'Click God', req: 100000, reward: 100000 },
          { id: 'click6', name: 'Ultimate Clicker', req: 1000000, reward: 1000000 }
        ],
        corndogs: [
          { id: 'dogs1', name: 'First Bite', req: 50, reward: 50 },
          { id: 'dogs2', name: 'Corn Dog Novice', req: 500, reward: 500 },
          { id: 'dogs3', name: 'Corn Dog Expert', req: 5000, reward: 5000 },
          { id: 'dogs4', name: 'Corn Dog Master', req: 50000, reward: 50000 },
          { id: 'dogs5', name: 'Corn Dog Legend', req: 500000, reward: 500000 },
          { id: 'dogs6', name: 'Corn Dog God', req: 5000000, reward: 5000000 }
        ],
        bosses: [
          { id: 'boss1', name: 'Boss Slayer', req: 1, reward: 2000 },
          { id: 'boss2', name: 'Boss Hunter', req: 5, reward: 10000 },
          { id: 'boss3', name: 'Boss Master', req: 25, reward: 50000 },
          { id: 'boss4', name: 'Boss Destroyer', req: 100, reward: 250000 }
        ],
        golden: [
          { id: 'golden1', name: 'Lucky Find', req: 1, reward: 1000 },
          { id: 'golden2', name: 'Golden Hunter', req: 10, reward: 10000 },
          { id: 'golden3', name: 'Golden Master', req: 50, reward: 50000 },
          { id: 'golden4', name: 'Golden God', req: 100, reward: 100000 }
        ],
        special: [
          { id: 'speed1', name: 'Speed Demon', req: 100, reward: 5000, desc: 'Get a 100x combo' },
          { id: 'rich1', name: 'Millionaire', req: 1000000, reward: 25000, desc: 'Earn $1,000,000' },
          { id: 'prestige1', name: 'Ascension', req: 1, reward: 100000, desc: 'Prestige once' },
          { id: 'time1', name: 'Dedicated Player', req: 3600, reward: 15000, desc: 'Play for 1 hour' }
        ]
      };
      
      const SPECIAL_EVENTS = [
        { name: "Corn Dog Rain", duration: 10000, spawnRate: 300 },
        { name: "Boss Rush", duration: 30000, bossOnly: true },
        { name: "Golden Hour", duration: 60000, goldenChance: 0.1 },
        { name: "Summer BBQ", duration: 30000, clickMultiplier: 2, theme: "summer" },
        { name: "Halloween Feast", duration: 30000, spawnRate: 500, theme: "halloween" },
        { name: "Winter Festival", duration: 30000, goldenChance: 0.2, theme: "winter" },
        { name: "Double DPS", duration: 20000, dpsMultiplier: 2 }
      ];
      
      const BOSSES = [
        { name: "Mega Corn Dog", health: 100, reward: 500, image: "üå≠", scale: 2, abilities: [] },
        { name: "Mustard King", health: 500, reward: 2000, image: "üëë", scale: 2.5, abilities: ["splash"] },
        { name: "Deep Fryer Boss", health: 2000, reward: 10000, image: "üî•", scale: 3, abilities: ["burn"] },
        { name: "Corn Dog Reaper", health: 10000, reward: 50000, image: "üíÄ", scale: 4, abilities: ["summon"] },
        { name: "Ketchup Queen", health: 5000, reward: 25000, image: "üë∏", scale: 3, abilities: ["heal"] },
        { name: "Robot Dog-3000", health: 15000, reward: 75000, image: "ü§ñ", scale: 4, abilities: ["shield"] },
        { name: "The Carnival Master", health: 20000, reward: 100000, image: "üé™", scale: 4, abilities: ["multiply"] },
        { name: "Ancient Corn Spirit", health: 50000, reward: 250000, image: "üëª", scale: 5, abilities: ["all"] }
      ];
      
      const UPGRADES = {
        autoClicker: { base: 100, scale: 1.5, name: "Auto-Eater", maxLevel: 100 },
        multiplier: { base: 50, scale: 2, name: "Click Power", maxLevel: 50 },
        passive: { base: 200, scale: 2, name: "Passive Income", maxLevel: 50 },
        critical: { base: 300, scale: 2.5, name: "Critical Hits", maxLevel: 25 },
        combo: { base: 400, scale: 2, name: "Combo Master", maxLevel: 10 },
        luck: { base: 500, scale: 2, name: "Lucky Strikes", maxLevel: 10 },
        magnet: { base: 600, scale: 2, name: "Corn Dog Magnet", maxLevel: 5 },
        golden: { base: 1000, scale: 3, name: "Golden Touch", maxLevel: 5 },
        timeWarp: { base: 2000, scale: 3, name: "Time Warper", maxLevel: 3 },
        multiClick: { base: 3000, scale: 3, name: "Multi-Click", maxLevel: 5 }
      };

      async function saveData() {
        if (!userId) return;
        
        const dataToSave = {
          count: Math.floor(count) || 0,
          money: Math.floor(money) || 0,
          multiplier: Math.floor(multiplier) || 1,
          autoClickers: Math.floor(autoClickers) || 0,
          upgradeLevel: Math.floor(upgradeLevel) || 1,
          passiveIncome: Math.floor(passiveIncome) || 0,
          prestigeLevel: Math.floor(prestigeLevel) || 0,
          achievements: achievements || {},
          username: username || auth.currentUser?.email?.split('@')[0] || 'Unknown',
          totalClicks: Math.floor(totalClicks) || 0,
          maxCombo: Math.floor(maxCombo) || 0,
          goldenCornDogsFound: Math.floor(goldenCornDogsFound) || 0,
          bossKills: Math.floor(bossKills) || 0,
          timePlayedSeconds: Math.floor(timePlayedSeconds) || 0,
          lastUpdated: Date.now()
        };
        
        try {
          await setDoc(doc(db, "users", userId), dataToSave);
          updateLeaderboard();
        } catch (error) {
          console.error('Save error:', error);
        }
      }
      
      async function updateLeaderboard() {
        const leaderboardElem = document.getElementById("leaderboard");
        if (!leaderboardElem) return;
        
        try {
          const snapshot = await getDocs(query(
            collection(db, "users"),
            orderBy("count", "desc"),
            limit(10)
          ));
          
          let leaderboardHTML = `
            <div class="leaderboard-header">
              <h3>üèÜ Top Corn Dog Eaters</h3>
            </div>
            <div class="leaderboard-entries">
          `;
          
          let rank = 1;
          snapshot.forEach((doc) => {
            const data = doc.data();
            const isCurrentUser = doc.id === userId;
            
            // Strict validation to prevent NaN
            const rawCount = data.count;
            const rawUsername = data.username;
            
            // Skip entries with invalid data
            if (rawCount === null || rawCount === undefined || isNaN(rawCount) || rawCount < 0) {
              return;
            }
            
            if (!rawUsername || typeof rawUsername !== 'string' || rawUsername.trim() === '') {
              return;
            }
            
            const displayCount = numberFormat(Math.floor(rawCount));
            const displayUsername = rawUsername.trim().substring(0, 15); // Limit length
            
            leaderboardHTML += `
              <div class="leaderboard-entry ${isCurrentUser ? 'current-user' : ''}">
                <span class="rank">#${rank}</span>
                <span class="username">${displayUsername}</span>
                <span class="score">${displayCount} üå≠</span>
              </div>
            `;
            rank++;
          });
          
          if (rank === 1) {
            leaderboardHTML += `<div class="leaderboard-empty">No valid scores yet!</div>`;
          }
          
          leaderboardHTML += `</div>`;
          leaderboardElem.innerHTML = leaderboardHTML;
        } catch (error) {
          console.error('Error updating leaderboard:', error);
          leaderboardElem.innerHTML = `
            <div class="leaderboard-header">
              <h3>üèÜ Top Corn Dog Eaters</h3>
            </div>
            <div class="leaderboard-error">Failed to load leaderboard</div>
          `;
        }
      }
      
      function handleUpgrade(type) {
        return async () => {
          const upgrade = UPGRADES[type];
          if (!upgrade) return;
          
          let current, cost;
          
          switch(type) {
            case "multiplier":
              current = multiplier - 1;
              cost = Math.floor(upgrade.base * Math.pow(upgrade.scale, current));
              if (money >= cost) {
                money -= cost;
                multiplier++;
              }
              break;
            case "autoClicker":
              current = autoClickers;
              cost = Math.floor(upgrade.base * Math.pow(upgrade.scale, current));
              if (money >= cost) {
                money -= cost;
                autoClickers++;
              }
              break;
            case "passive":
              current = passiveIncome;
              cost = Math.floor(upgrade.base * Math.pow(upgrade.scale, current));
              if (money >= cost) {
                money -= cost;
                passiveIncome++;
              }
              break;
          }
          
          updateUI();
          await saveData();
        };
      }

      function spawnFloatingText(x, y, text, type = 'normal') {
        const float = document.createElement("div");
        float.className = `floating-text floating-${type}`;
        float.style.left = x + "px";
        float.style.top = y + "px";
        float.textContent = text;
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 2000);
      }

      // Auto-clicker and passive income interval
      setInterval(() => {
        if (autoClickers > 0 || passiveIncome > 0) {
          const earnings = autoClickers + passiveIncome;
          count += earnings;
          money += earnings;
          updateUI();
          if (userId) saveData();
        }
      }, 1000);

      function numberFormat(num) {
        if (!num || isNaN(num)) return '0';
        if (num >= 1e12) return (num/1e12).toFixed(1) + 'T';
        if (num >= 1e9) return (num/1e9).toFixed(1) + 'B';
        if (num >= 1e6) return (num/1e6).toFixed(1) + 'M';
        if (num >= 1e3) return (num/1e3).toFixed(1) + 'K';
        return Math.floor(num).toString();
      }

      function checkAchievements() {
        // Check all achievement categories
        ACHIEVEMENTS.clicks.forEach(ach => {
          if (!achievements[ach.id] && totalClicks >= ach.req) {
            unlockAchievement(ach);
          }
        });
        
        ACHIEVEMENTS.corndogs.forEach(ach => {
          if (!achievements[ach.id] && count >= ach.req) {
            unlockAchievement(ach);
          }
        });
        
        ACHIEVEMENTS.bosses.forEach(ach => {
          if (!achievements[ach.id] && bossKills >= ach.req) {
            unlockAchievement(ach);
          }
        });
        
        ACHIEVEMENTS.golden.forEach(ach => {
          if (!achievements[ach.id] && goldenCornDogsFound >= ach.req) {
            unlockAchievement(ach);
          }
        });

        // Check special achievements
        if (ACHIEVEMENTS.special) {
          ACHIEVEMENTS.special.forEach(ach => {
            let shouldUnlock = false;
            switch(ach.id) {
              case 'speed1':
                shouldUnlock = maxCombo >= 100;
                break;
              case 'rich1':
                shouldUnlock = money >= 1000000;
                break;
              case 'prestige1':
                shouldUnlock = prestigeLevel >= 1;
                break;
              case 'time1':
                shouldUnlock = timePlayedSeconds >= 3600;
                break;
            }
            
            if (!achievements[ach.id] && shouldUnlock) {
              unlockAchievement(ach);
            }
          });
        }
      }

      function unlockAchievement(ach) {
        achievements[ach.id] = true;
        money += ach.reward;
        spawnFloatingText(
          window.innerWidth/2,
          window.innerHeight/2,
          `üèÜ ${ach.name}\n+${numberFormat(ach.reward)}!`,
          'achievement'
        );
        saveData();
      }

      function updateCombo(x, y) {
        const now = Date.now();
        if (now - lastClickTime < MAX_COMBO_TIME) {
          comboCount++;
          if (comboCount > maxCombo) {
            maxCombo = comboCount;
          }
          if (comboCount > 1) {
            spawnFloatingText(x, y - 30, `Combo x${comboCount}!`, 'combo');
          }
        } else {
          comboCount = 1;
        }
        lastClickTime = now;
      }

      function startRandomEvent() {
        if (Math.random() < 0.1) { // 10% chance every minute
          const event = SPECIAL_EVENTS[Math.floor(Math.random() * SPECIAL_EVENTS.length)];
          startEvent(event);
        }
      }

      function startEvent(event) {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-announcement';
        eventDiv.textContent = `üéâ ${event.name} Started! üéâ`;
        document.body.appendChild(eventDiv);
        
        let originalSpawnRate = 1200;
        if (event.spawnRate) {
          clearInterval(spawnInterval);
          spawnInterval = setInterval(spawnCornDog, event.spawnRate);
        }
        
        if (event.goldenChance) {
          const originalChance = goldenCornDogChance;
          goldenCornDogChance = event.goldenChance;
          setTimeout(() => { goldenCornDogChance = originalChance; }, event.duration);
        }
        
        setTimeout(() => {
          eventDiv.remove();
          if (event.spawnRate) {
            clearInterval(spawnInterval);
            spawnInterval = setInterval(spawnCornDog, originalSpawnRate);
          }
        }, event.duration);
      }

      function handlePrestige() {
        if (count >= PRESTIGE_COST) {
          prestigeLevel++;
          prestigeMultiplier = 1 + (prestigeLevel * 0.5);
          count = 0;
          money = 0;
          multiplier = 1;
          autoClickers = 0;
          passiveIncome = 0;
          updateUI();
          saveData();
          spawnFloatingText(
            window.innerWidth/2,
            window.innerHeight/2,
            `üåü Prestiged! New multiplier: x${prestigeMultiplier.toFixed(1)}`,
            'prestige'
          );
        }
      }

      // Constants
      const DAILY_CHALLENGES = [
        { id: 'speed', name: 'Speed Demon', desc: 'Click 1000 times in 5 minutes', reward: 10000 },
        { id: 'combo', name: 'Combo King', desc: 'Get a 50x combo', reward: 15000 },
        { id: 'boss', name: 'Boss Hunter', desc: 'Defeat 5 bosses', reward: 20000 },
        { id: 'golden', name: 'Golden Rush', desc: 'Find 3 golden corn dogs', reward: 25000 },
        { id: 'perfect', name: 'Perfect Run', desc: 'Play for 10 minutes without missing a corn dog', reward: 30000 }
      ];

      function checkDailyChallenges() {
        const now = new Date();
        if (now.getTime() - lastDailyReset > 24 * 60 * 60 * 1000) {
          dailyProgress = {};
          lastDailyReset = now.getTime();
          alert('New daily challenges available!');
        }
      }

      // Initialize DOM elements and attach event listeners
      document.addEventListener("DOMContentLoaded", () => {
        console.log('DOM Content Loaded');
        
        // Initialize all UI elements first
        counterElem = document.getElementById("counter");
        moneyElem = document.getElementById("money");
        dpsElem = document.getElementById("dps");

        // Setup login form handler
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
          loginForm.addEventListener('submit', handleLogin);
          console.log('Login form handler attached');
        }
        
        // Setup game UI elements
        const prestigeBtn = document.getElementById('prestige-btn');
        if (prestigeBtn) {
          prestigeBtn.addEventListener('click', handlePrestige);
        }

        // Setup shop tabs
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.shop-content').forEach(content => {
              content.classList.remove('active');
            });
            document.getElementById(btn.dataset.tab).classList.add('active');
          });
        });

        // Setup panel toggle buttons
        const setupPanelToggle = (buttonId, panelId) => {
          const button = document.getElementById(buttonId);
          const panel = document.getElementById(panelId);
          if (button && panel) {
            button.addEventListener('click', () => {
              panel.classList.toggle('panel-hidden');
              const isHidden = panel.classList.contains('panel-hidden');
              button.innerHTML = isHidden ? 'üëÅÔ∏è' : '‚ùå';
              button.title = isHidden ? `Show ${panelId}` : `Hide ${panelId}`;
            });
          }
        };

        setupPanelToggle('toggle-shop', 'shop');
        setupPanelToggle('toggle-leaderboard', 'leaderboard');
        setupPanelToggle('toggle-stats', 'stats-container');
        setupPanelToggle('toggle-chat', 'chat-container');

        // Setup master hide/show button
        const masterToggle = document.getElementById('master-toggle');
        if (masterToggle) {
          masterToggle.addEventListener('click', () => {
            const panels = ['shop', 'leaderboard', 'stats-container', 'chat-container'];
            const allHidden = panels.every(id => {
              const panel = document.getElementById(id);
              return panel && panel.classList.contains('panel-hidden');
            });
            
            panels.forEach(id => {
              const panel = document.getElementById(id);
              const toggleId = id === 'stats-container' ? 'toggle-stats' : 
                              id === 'chat-container' ? 'toggle-chat' : 
                              `toggle-${id}`;
              const toggle = document.getElementById(toggleId);
              if (panel) {
                if (allHidden) {
                  panel.classList.remove('panel-hidden');
                  if (toggle) {
                    toggle.innerHTML = '‚ùå';
                    toggle.title = `Hide ${id}`;
                  }
                } else {
                  panel.classList.add('panel-hidden');
                  if (toggle) {
                    toggle.innerHTML = 'üëÅÔ∏è';
                    toggle.title = `Show ${id}`;
                  }
                }
              }
            });
            
            masterToggle.innerHTML = allHidden ? 'üôà' : 'üëÄ';
          });
        }

        // Setup chat
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        if (chatForm && chatInput) {
          chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
              await sendChatMessage(message);
              chatInput.value = '';
            }
          });
        }

        // Initialize game state if user is already logged in
        const currentUser = auth.currentUser;
        if (currentUser) {
          userId = currentUser.uid;
          showGameUI();
          if (!gameStarted) {
            startGame();
            gameStarted = true;
          }
        } else {
          showLoginUI();
        }

        // Prevent touch scrolling on mobile
        document.addEventListener('touchmove', (e) => {
          if (e.target.closest('.chat-messages') || 
              e.target.closest('.leaderboard-entries') || 
              e.target.closest('.shop-content')) {
            return; // Allow scrolling in these areas
          }
          e.preventDefault();
        }, { passive: false });
      });
  </script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      overflow: hidden;
      min-height: 100vh;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    
    h1 {
      font-size: clamp(1.5rem, 4vw, 3rem);
      margin: 1rem 0;
      background: linear-gradient(45deg, #ffcc00, #ff9900, #ffcc00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
      font-weight: bold;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .main-stats, .secondary-stats {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #ffcc00;
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 204, 0, 0.2);
    }
    
    .main-stats h3, .secondary-stats h3 {
      margin-top: 0;
      color: #ffcc00;
      font-size: 1.2rem;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .stat-label {
      color: #ccc;
      font-size: 0.9rem;
    }
    
    .stat-value {
      color: #ffcc00;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    #counter {
      font-size: clamp(1.2rem, 3vw, 2rem);
      color: #ffcc00;
      font-weight: bold;
    }
    
    #money {
      font-size: clamp(1rem, 2.5vw, 1.5rem);
      color: #4ade80;
      font-weight: bold;
    }
    
    #dps {
      font-size: clamp(0.9rem, 2vw, 1.2rem);
      color: #60a5fa;
      font-weight: bold;
    }
    
    .corndog {
      position: absolute;
      font-size: 2.5rem;
      cursor: pointer;
      user-select: none;
      z-index: 10;
      transition: all 0.2s ease;
      filter: drop-shadow(0 0 10px rgba(255, 204, 0, 0.5));
      touch-action: none;
    }
    
    .corndog:hover {
      transform: scale(1.3);
      filter: drop-shadow(0 0 20px rgba(255, 204, 0, 0.8));
    }
    
    .golden-corndog {
      animation: goldPulse 1s infinite;
      filter: brightness(1.5) sepia(1) saturate(5) drop-shadow(0 0 20px gold);
    }
    
    @keyframes goldPulse {
      0% { transform: scale(1); filter: brightness(1.5) sepia(1) saturate(5) drop-shadow(0 0 20px gold); }
      50% { transform: scale(1.1); filter: brightness(2) sepia(1) saturate(6) drop-shadow(0 0 30px gold); }
      100% { transform: scale(1); filter: brightness(1.5) sepia(1) saturate(5) drop-shadow(0 0 20px gold); }
    }
    
    .floating-text {
      position: absolute;
      font-size: 1.2rem;
      font-weight: bold;
      animation: floatUp 2s ease-out forwards;
      pointer-events: none;
      z-index: 100;
    }
    
    .floating-normal { color: #ffcc00; }
    .floating-crit { color: #ff4444; font-size: 1.5rem; }
    .floating-golden { color: gold; font-size: 1.8rem; }
    .floating-damage { color: #ff6b6b; }
    .floating-boss-reward { color: #4ade80; font-size: 2rem; }
    .floating-achievement { color: #a855f7; font-size: 1.5rem; }
    .floating-prestige { color: #fbbf24; font-size: 2rem; }
    .floating-combo { color: #06b6d4; }
    
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) scale(1.2); }
    }
    
    #shop {
      position: fixed;
      right: 20px;
      top: 20px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ffcc00;
      border-radius: 15px;
      padding: 20px;
      max-width: 350px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 204, 0, 0.3);
    }
    
    .shop-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .tab-btn {
      background: rgba(255, 204, 0, 0.1);
      border: 1px solid #ffcc00;
      color: #ffcc00;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
      flex: 1;
    }
    
    .tab-btn.active {
      background: #ffcc00;
      color: black;
      font-weight: bold;
    }
    
    .tab-btn:hover:not(.active) {
      background: rgba(255, 204, 0, 0.2);
    }
    
    .shop-content {
      display: none;
      max-height: 400px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .shop-content.active {
      display: block;
    }
    
    .upgrade {
      margin-bottom: 12px;
    }
    
    .upgrade button {
      width: 100%;
      background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
      border: none;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    .upgrade button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 204, 0, 0.4);
    }
    
    .upgrade button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666 0%, #444 100%);
    }
    
    .upgrade-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .upgrade-icon {
      font-size: 1.5rem;
    }
    
    .upgrade-name {
      font-size: 1.1rem;
      color: #000;
      font-weight: bold;
      flex: 1;
      text-align: left;
    }
    
    .upgrade-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .upgrade-desc {
      font-size: 0.9rem;
      color: #333;
    }
    
    .upgrade-cost {
      font-size: 1rem;
      color: #000;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .boss {
      position: fixed;
      cursor: pointer;
      user-select: none;
      text-align: center;
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 40px rgba(255, 68, 68, 0.5);
      z-index: 50;
      touch-action: none;
    }
    
    .boss-name {
      color: #ff4444;
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
    }
    
    .boss-health {
      width: 250px;
      height: 20px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
      border: 2px solid #666;
    }
    
    .health-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff0000, #ff4400);
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 68, 68, 0.6);
    }
    
    .boss-image {
      font-size: 4rem;
      margin: 15px 0;
      animation: bossFloat 2s ease-in-out infinite;
    }
    
    @keyframes bossFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .boss-hp {
      color: #ffcc00;
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .login-container {
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ffcc00;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      margin: 2rem auto;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 204, 0, 0.3);
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .login-form input {
      padding: 15px;
      border: 2px solid #ffcc00;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: #ff9900;
      box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
    }
    
    .login-form input::placeholder {
      color: rgba(255, 204, 0, 0.5);
    }
    
    .login-form button {
      background: linear-gradient(135deg, #ffcc00, #ff9900);
      border: none;
      padding: 15px;
      color: black;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1.2rem;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    
    .login-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 204, 0, 0.4);
    }
    
    #reaper {
      max-width: min(400px, 80vw);
      height: auto;
      border: 3px solid #ff9900;
      border-radius: 15px;
      margin: 1rem auto;
      box-shadow: 0 0 30px rgba(255, 153, 0, 0.5);
      display: block;
    }
    
    #leaderboard {
      position: fixed;
      left: 20px;
      top: 20px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ffcc00;
      border-radius: 15px;
      padding: 20px;
      max-width: 300px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 204, 0, 0.3);
    }
    
    .leaderboard-header h3 {
      margin: 0 0 15px 0;
      color: #ffcc00;
      font-size: 1.2rem;
    }
    
    .leaderboard-entries {
      max-height: 300px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
    }
    
    .leaderboard-entry:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .leaderboard-entry.current-user {
      background: rgba(255, 204, 0, 0.2);
      border: 1px solid #ffcc00;
    }
    
    .rank {
      font-weight: bold;
      color: #ffcc00;
      min-width: 30px;
    }
    
    .username {
      flex: 1;
      text-align: left;
      margin: 0 10px;
      font-size: 0.9rem;
    }
    
    .score {
      font-weight: bold;
      color: #4ade80;
      font-size: 0.9rem;
    }
    
    .leaderboard-error {
      color: #ff6b6b;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }
    
    .prestige-button {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      border: none;
      padding: 15px 30px;
      color: white;
      font-size: 1.1rem;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      margin: 20px;
      transition: all 0.3s;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(10px);
      touch-action: manipulation;
    }
    
    .prestige-button:hover:not(:disabled) {
      transform: translateX(-50%) translateY(-3px);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
    }
    
    .prestige-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666, #444);
    }
    
    .prestige-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-icon {
      font-size: 1.5rem;
    }
    
    .prestige-text {
      font-size: 1.2rem;
    }
    
    .prestige-req {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .event-announcement {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #ffcc00;
      border-radius: 15px;
      padding: 30px;
      font-size: 1.8rem;
      font-weight: bold;
      animation: eventPulse 3s ease-in-out;
      z-index: 200;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 50px rgba(255, 204, 0, 0.5);
    }
    
    @keyframes eventPulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      10% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      90% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
    }
    
    .panel-hidden {
      display: none !important;
    }
    
    .toggle-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #ffcc00;
      color: #ffcc00;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    
    .toggle-button:hover {
      background: rgba(255, 204, 0, 0.2);
      transform: scale(1.1);
    }
    
    .master-toggle {
      position: fixed;
      top: 10px;
      right: 50%;
      transform: translateX(50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ffcc00;
      color: #ffcc00;
      padding: 8px 16px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 1000;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      touch-action: manipulation;
    }
    
    .master-toggle:hover {
      background: rgba(255, 204, 0, 0.1);
      transform: translateX(50%) scale(1.05);
    }
    
    /* Chat styles */
    .chat-container {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 350px;
      max-width: calc(100vw - 40px);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #ffcc00;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(255, 204, 0, 0.3);
      display: flex;
      flex-direction: column;
      height: 400px;
      max-height: 50vh;
    }
    
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 204, 0, 0.3);
      color: #ffcc00;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 15px;
      touch-action: pan-y;
    }
    
    .chat-message {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-message.own-message {
      background: rgba(255, 204, 0, 0.1);
      border-color: rgba(255, 204, 0, 0.3);
    }
    
    .chat-username {
      font-weight: bold;
      color: #ffcc00;
      font-size: 0.9rem;
    }
    
    .chat-count {
      float: right;
      color: #4ade80;
      font-size: 0.8rem;
    }
    
    .chat-text {
      margin-top: 5px;
      color: #fff;
      word-wrap: break-word;
      font-size: 0.9rem;
    }
    
    .chat-form {
      display: flex;
      padding: 15px;
      gap: 10px;
      border-top: 1px solid rgba(255, 204, 0, 0.3);
    }
    
    .chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ffcc00;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: #ff9900;
      box-shadow: 0 0 5px rgba(255, 204, 0, 0.3);
    }
    
    .chat-send {
      background: #ffcc00;
      border: none;
      color: black;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    
    .chat-send:hover {
      background: #ff9900;
      transform: scale(1.05);
    }
    
    /* Achievement styles that were missing */
    .achievement-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border: 2px solid #ffcc00;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: achievementSlide 4s ease-in-out forwards;
      box-shadow: 0 8px 32px rgba(251, 191, 36, 0.4);
      max-width: 300px;
    }
    
    @keyframes achievementSlide {
      0% { transform: translateX(100%); opacity: 0; }
      10% { transform: translateX(0); opacity: 1; }
      90% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    
    .achievement-icon {
      font-size: 2rem;
      color: #000;
    }
    
    .achievement-content {
      flex: 1;
      color: #000;
    }
    
    .achievement-title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .achievement-reward {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .achievements-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .achievement-category {
      margin-bottom: 20px;
    }
    
    .achievement-category h4 {
      color: #ffcc00;
      margin: 0 0 10px 0;
      font-size: 1rem;
      border-bottom: 1px solid rgba(255, 204, 0, 0.3);
      padding-bottom: 5px;
    }
    
    .achievement {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .achievement:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .achievement.unlocked {
      background: rgba(255, 204, 0, 0.15);
      border-color: rgba(255, 204, 0, 0.3);
    }
    
    .achievement-info {
      margin-bottom: 8px;
    }
    
    .achievement-name {
      font-weight: bold;
      color: #fff;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    
    .achievement.unlocked .achievement-name {
      color: #ffcc00;
    }
    
    .achievement-desc {
      font-size: 0.8rem;
      color: #ccc;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        touch-action: pan-y;
      }
      
      h1 {
        font-size: 1.4rem;
        margin: 0.5rem 0;
      }
      
      #shop {
        position: fixed;
        bottom: 80px;
        right: 10px;
        left: 10px;
        top: auto;
        max-width: none;
        max-height: 35vh;
        padding: 15px;
      }
      
      #leaderboard {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        max-width: none;
        max-height: 25vh;
        padding: 15px;
      }
      
      .stats-container {
        margin: 10px;
        gap: 10px;
        position: relative;
        grid-template-columns: 1fr;
        max-height: 30vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .prestige-button {
        bottom: 10px;
        padding: 10px 20px;
        font-size: 0.9rem;
      }
      
      .corndog {
        font-size: 2.2rem;
      }
      
      .boss {
        max-width: 90vw;
        padding: 15px;
      }
      
      .boss-health {
        width: 200px;
      }
      
      .master-toggle {
        top: 5px;
        padding: 6px 12px;
        font-size: 1rem;
      }
      
      .toggle-button {
        width: 25px;
        height: 25px;
        font-size: 0.7rem;
      }
      
      .chat-container {
        bottom: 60px;
        right: 10px;
        left: 10px;
        width: auto;
        height: 300px;
      }
      
      #reaper {
        max-width: 60vw;
        margin: 0.5rem auto;
      }
      
      .upgrade button {
        padding: 12px;
      }
      
      .upgrade-icon {
        font-size: 1.2rem;
      }
      
      .upgrade-name {
        font-size: 0.9rem;
      }
      
      .upgrade-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .shop-content {
        max-height: 25vh;
      }
      
      .leaderboard-entries {
        max-height: 15vh;
      }
    }
    
    @media (max-width: 480px) {
      .stats-container {
        display: none; /* Hide stats on very small screens to save space */
      }
      
      .corndog {
        font-size: 2rem;
      }
      
      .floating-text {
        font-size: 1rem;
      }
      
      .boss {
        padding: 10px;
      }
      
      .boss-name {
        font-size: 1.2rem;
      }
      
      .boss-image {
        font-size: 3rem;
      }
    }
    
    /* Prevent text selection on game elements */
    .corndog, .boss, button, .stat-value, .stat-label {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Improve touch targets */
    button, .corndog, .boss, .tab-btn, .toggle-button {
      min-width: 44px;
      min-height: 44px;
    }
    
    /* Game area for better corn dog spawning */
    #game-area {
      position: fixed;
      top: 100px;
      left: 0;
      right: 0;
      bottom: 100px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="loginUI">
    <h1>Today I Will Eat Five Corn Dogs</h1>
    <div class="login-container">
      <h2>üå≠ Enter the Corn Dog Realm</h2>
      <form id="loginForm" class="login-form">
        <input type="text" id="username" placeholder="Choose a username (3+ characters)" required minlength="3">
        <input type="password" id="password" placeholder="Choose a password (6+ characters)" required minlength="6">
        <p style="color: #ffcc00; font-size: 0.9rem; margin: 0;">
          New players get an account created automatically!
        </p>
        <button type="submit">üéÆ Start Playing</button>
      </form>
    </div>
  </div>

  <div id="gameContent" style="display: none;">
    <h1>Today I Will Eat Five Corn Dogs</h1>
    
    <button class="master-toggle" id="master-toggle">üëÄ</button>
    
    <div class="stats-container" id="stats-container">
      <button class="toggle-button" id="toggle-stats" title="Hide stats">‚ùå</button>
      <div class="main-stats">
        <h3>üìä Main Stats</h3>
        <div class="stat-item">
          <span class="stat-label">üå≠ Corn Dogs Eaten:</span>
          <span class="stat-value" id="counter">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">üí∞ Money:</span>
          <span class="stat-value" id="money">$0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">‚ö° Per Second:</span>
          <span class="stat-value" id="dps">0/s</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">‚≠ê Prestige:</span>
          <span class="stat-value" id="prestige-info">Lv.0 (x1.0)</span>
        </div>
      </div>
      
      <div class="secondary-stats">
        <h3>üéØ Performance</h3>
        <div class="stat-item">
          <span class="stat-label">üî• Current Combo:</span>
          <span class="stat-value" id="combo-counter">x1</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">üí¢ Crit Chance:</span>
          <span class="stat-value" id="crit-chance">10%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">‚ú® Golden Found:</span>
          <span class="stat-value" id="golden-found">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">üëπ Boss Kills:</span>
          <span class="stat-value" id="boss-kills">0</span>
        </div>
      </div>
    </div>
    
    <img src="corn-dog-reaper.gif" id="reaper" alt="Corn Dog Reaper">
    
    <div id="game-area"></div>
    
    <div id="shop">
      <button class="toggle-button" id="toggle-shop" title="Hide shop">‚ùå</button>
      <div class="shop-tabs">
        <button class="tab-btn active" data-tab="upgrades">üõí Shop</button>
        <button class="tab-btn" data-tab="achievements">üèÜ Awards</button>
        <button class="tab-btn" data-tab="stats">üìà Stats</button>
      </div>
      <div class="shop-content active" id="upgrades">
        <!-- Filled by updateUI() -->
      </div>
      <div class="shop-content" id="achievements">
        <div style="color: #ffcc00; text-align: center; padding: 20px;">
          üèÜ Achievements coming soon!
        </div>
      </div>
      <div class="shop-content" id="stats">
        <div class="stat-entry">Time Played: <span id="time-played">0:00</span></div>
        <div class="stat-entry">Total Clicks: <span id="total-clicks">0</span></div>
        <div class="stat-entry">Max Combo: <span id="max-combo">0</span></div>
        <div class="stat-entry">Golden Corn Dogs: <span id="golden-total">0</span></div>
      </div>
    </div>

    <div id="leaderboard">
      <button class="toggle-button" id="toggle-leaderboard" title="Hide leaderboard">‚ùå</button>
    </div>
    
    <div class="chat-container" id="chat-container">
      <button class="toggle-button" id="toggle-chat" title="Hide chat">‚ùå</button>
      <div class="chat-header">üí¨ Global Chat</div>
      <div class="chat-messages" id="chat-messages"></div>
      <form class="chat-form" id="chat-form">
        <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="200">
        <button type="submit" class="chat-send">Send</button>
      </form>
    </div>

    <button id="prestige-btn" class="prestige-button">
      <div class="prestige-content">
        <span class="prestige-icon">‚≠ê</span>
        <span class="prestige-text">PRESTIGE</span>
        <span class="prestige-req">Need 1M Corn Dogs</span>
      </div>
    </button>
  </div>

  <audio id="spawnSound" src="https://www.myinstants.com/media/sounds/minecraft-pop.mp3" preload="auto"></audio>
  <audio id="eatSound" src="https://www.myinstants.com/media/sounds/minecraft_eat.mp3" preload="auto"></audio>
</body>
</html>